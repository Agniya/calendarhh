<!DOCTYPE html>
	<html>
		<head>
		<link rel="stylesheet" href="calendar.css">
		<!--<script type="text/javascript" src="calendar.js"></script>-->
		<script>
		window.onload = function(){

		function Mnth(year,month){
			this.init(year,month);
		}
		Mnth.prototype = {
			curMonth:{},
			storage:{},
			//ind:0,
			init: function(year,month){
				var that = this;
				that.year=year;
				that.month=month;
				var list = that.renderCell();
				if(localStorage[that.month] !=undefined){that.storage = JSON.parse(localStorage[that.month]);}
							
				document.getElementById('Add').onclick = function(){
					var activeL = document.getElementsByClassName('days active');
					if(activeL.length>=1){
						var ind = activeL[0].getAttribute('index');
						that.showBox(ind);							
					};
				};
				
				document.getElementById('Update').onclick = function(){
					var activeL = document.getElementsByClassName('days active');
					if(activeL.length>=1){
						var ind = activeL[0].getAttribute('index');
						if(JSON.parse(localStorage[that.month])[ind] != undefined){
							var ev = activeL[0].querySelector('span.events');
							activeL[0].removeChild(ev);
							that.showBox(ind);
						}
					};
				};
				
				list.onclick = function(event){
					var event = event||window.event;
					for(var i=0;i<list.children.length;i++){
						that.removeModal(list.children[i]);
					} 
				
				if(event.target.tagName == 'LI'){	
					var prevActive = document.getElementsByClassName('days active');
					if(prevActive.length>=1){prevActive[0].classList.remove('active')};
					event.target.classList.add('active');
					if((event.target.className == 'days prevMnth')
					|| (event.target.className == 'days nextMnth'))return;}
					that.createEvent(that.ind,that.storage[that.ind][that.storage[that.ind].length-1]);
				} 
			},
			showBox: function(ind){
				var that = this;
				//that.storage[ind] = {}; 
				if(that.storage[ind]==undefined){that.storage[ind] = [];}
				var obj = {};
				that.storage[ind] = [];
				that.storage[ind].push(obj);
				var arrBox = that.renderBox(ind);
					arrBox.onclick = function(){ 
						var event = event||window.event;
						event.stopPropagation();
						if(event.target.tagName == 'INPUT'){
							document.getElementById(event.target.id).onblur = function(){
								//that.storage[ind][event.target.id] = event.target.value; 
								that.storage[ind][that.storage[ind].length-1][event.target.id] = event.target.value; 
								that.ind = ind;
								//console.log(that.ind);
								
							}
						}
							//console.log(that.storage[ind][that.storage[ind].length-1]); 
							localStorage[that.month] = JSON.stringify(that.storage);
							console.log(JSON.parse(localStorage[that.month])[ind]); 
					}
			},
			removeModal: function(el){
				try{
				while((el.lastChild != null)&&(el.lastChild.className == 'arrow-box')) el.removeChild(el.lastChild);
				el.parentNode.removeChild(el.lastChild);
				} catch (e){
				return false;
				}
				return true;
			},
			renderCell: function(){
				var list = document.createElement('ul');
				document.getElementById('1').appendChild(list);
				list.setAttribute('id','month'); 
				var start = new Date(this.year,this.month,1),
				td = start.getDay(),
				countDay = 1;
				console.log(td); // если td == 0
				if(td==0){td = 7};
				var a = function(t,elem){elem.innerHTML = t;} 
				var daysOfweek = ['вс','пн','вт','ср','чт','пт','сб'];
				var mnthNames = ['январь','‘евраль','ћарт','јпрель','ћай','»юнь','»юль','јвгуст','—ент€брь','ќкт€брь','Ќо€брь','ƒекабрь'];
				var daysAmmount = [31,28,31,30,31,30,31,31,30,31,30,31];
			
				for(var i=0;i<42;i++){
					var li = document.createElement('li'),
					day = document.createElement('span');
					list.appendChild(li);
					li.classList.add('days'); 
					day.classList.add('dayOfweek'); 
					li.setAttribute('index',i);
					if((i>=0)&&(i<7)){
						li.appendChild(day);
						if(i==6){a(daysOfweek[0],day)} else {a(daysOfweek[i+1],day);}
					}
					if(i==td-1){
						if(countDay <= daysAmmount[this.month]){
							var date = document.createElement('span');
							li.appendChild(date);
							date.classList.add('date'); 
							a(countDay,date);
							countDay++;
							td++;
						}else if(countDay > daysAmmount[this.month]){
							countDay = 1;
							var date = document.createElement('span');
							li.appendChild(date);
							li.classList.add('nextMnth');
							date.classList.add('date'); 
							a(countDay,date);
							countDay++;
							td++;				
						}						
					}					
				}
				
				var prevMonthDays = daysAmmount[this.month-1];
				var t = start.getDay();
				if(t==0){t = 7};
				for(var n=t-2;n >=0;n--)
				{
					var dat = document.createElement('span');
					list.children[n].appendChild(dat);
					list.children[n].classList.add('prevMnth');
					dat.classList.add('date'); 
					a(prevMonthDays,dat);	
					prevMonthDays--;
				}
				var el = document.getElementsByClassName('nextMnth')[0];
				var indStart = el.getAttribute('index');
				for(var n=indStart;n<42;n++)
				{
					var dat = document.createElement('span');
					list.children[n].classList.add('nextMnth');
				}
				return list;
			},
		renderBox: function(ind){
			
			var box = document.createElement('div'),//плашка дл€ записи дела
			form = document.createElement('form'),//форма 
			arrow = document.createElement('i');//стрелочка
			
			var list = document.getElementById('month');
			for(var n = 0; n< list.children.length; n++){
				if(list.children[n].getAttribute('index') == ind){list.children[n].appendChild(box);} //добавление плашки к €чейке, по которой кликнули
			}			
			
			box.classList.add('arrow-box');
			box.appendChild(form);
			form.setAttribute('id','make_event');

			//создание необходимых ƒќћ-узлов 
			function initElems(){
				var elem = {};
				elem.div = document.createElement('div');
				elem.label = document.createElement('label');
				elem.input = document.createElement('input');
				return elem;
			}

			function makeInputBlock(name,id){
				var el = initElems();
				form.appendChild(el.div);
				el.div.appendChild(el.label);
				el.label.innerHTML = name;
				el.label.setAttribute('for',id);
				form.appendChild(el.div); 
				el.div.appendChild(el.input);
				el.input.setAttribute('id',id);
			}

			makeInputBlock('Events','action');
			makeInputBlock('Members','members');
			makeInputBlock('Time','time');

			box.appendChild(arrow);
			arrow.classList.add('arrow');
			return box;
		},
		createEvent: function(ind,obj){
			var span = document.createElement('span'),
			list = document.getElementById('month');
			list.children[ind].appendChild(span);
			span.innerHTML = 'Event: ' + obj['action'];
			span.innerHTML += '<br/>Members: ' +obj['members'];
			span.innerHTML += '<br/>Time: ' +obj['time']; 
			span.classList.add('events');
			}
		}
		
		//»Ќ»÷»јЋ»«ј÷»я
		
		//начальна€ - текуща€ дата 
		var mnthNames = ['январь','‘евраль','ћарт','јпрель','ћай','»юнь','»юль','јвгуст','—ент€брь','ќкт€брь','Ќо€брь','ƒекабрь'];
		var today = new Date(),
		year = today.getFullYear(),
		month = today.getMonth(),
		//создаетс€ экземпл€р текущего мес€ца - объект передаетс€ текущий год и мес€ц
		mnth = new Mnth(year,month); 
		getEvents();
		document.getElementById('currentM').innerHTML = mnthNames[month]+' '+year;
		//console.log(JSON.parse(localStorage[month]));
		function getEvents(){
			if(localStorage[month] !=undefined){
				var obj = JSON.parse(localStorage[month]);
				var calend = document.getElementById('month');
				for(var i=0;i<calend.children.length;i++){
					var ind = calend.children[i].getAttribute('index');
					
					if(obj[ind]!=undefined){
					
						for(var n=0;n<obj[ind].length;n++){
							console.log(JSON.parse(localStorage[month])[ind][n]); 		
							mnth.createEvent(ind,obj[ind][n]);
						}
					}
				}
			}
		};
		//localStorage.clear();
		//по клику на стрелку определ€етс€ новое значение мес€ца
		//значение передаетс€ в новый экземпл€р мес€ца
		//в currentM - новый мес€ц
		var changeMnth = document.getElementById('change_mnth');
		changeMnth.onclick = function(){
			var div = document.getElementById('1');
			var m = document.getElementById('month');
			
			if(event.target.getAttribute('value') == 'Previous'){
				div.removeChild(m);
				delete mnth; 
				month -= 1;
				if(month == -1){month = 11;year -=1;}
				var mnth = new Mnth(year,month); 
				getEvents();
				document.getElementById('currentM').innerHTML = mnthNames[month]+' '+year;				
			}else if(event.target.getAttribute('value') == 'Next'){
				div.removeChild(m);
				delete mnth; 
				month += 1;
				if(month == 12){month = 0;year +=1;}
				var mnth = new Mnth(year,month); 
				getEvents();
				document.getElementById('currentM').innerHTML = mnthNames[month]+' '+year;				
			}
		}
		
}
		</script>
		</head>
		<body>
		<div id="options">
			<input type="button" id="Add" value="Add"><input type="button" id="Update" value="Update">
		</div>
		<div id="change_mnth">
			<input type="button" id="Previous" value="Previous"><span id="currentM"></span><input type="button" id="Next" value="Next">
		</div>	
		<div id = "1"></div>

		</div>
		</div>
		</body>
	</html>