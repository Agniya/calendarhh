<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="calendar.css">
<!--<script type="text/javascript" src="calendar.js"></script>-->
<script>
window.onload = function(){

function Mnth(year,month){
this.init(year,month);
}
Mnth.prototype = {
curMonth:{},
storage:{},
//ind:0,
init: function(year,month){
var that = this;
that.year=year;
that.month=month;
var list = that.renderCell();
if(localStorage[that.month] !=undefined){that.storage = JSON.parse(localStorage[that.month]);}
else{console.log(1)}

list.onclick = function(event){
for(var i=0;i<list.children.length;i++){
that.removeModal(list.children[i]);
} 
that.showBox(); 
} 
},
showBox: function(event){
var that = this;
var event = event||window.event;
if(event.target.tagName == 'LI'){ 
var ind = event.target.getAttribute('index');
that.storage[ind] = {}; 
var arrBox = that.renderBox();
arrBox.onclick = function(){ 
var event = event||window.event;
event.stopPropagation();
if(event.target.tagName == 'INPUT'){
document.getElementById(event.target.id).onblur = function(){
that.storage[ind][event.target.id] = event.target.value; 
that.ind = ind;
}
}
console.log(that.storage[ind]); 
localStorage[that.month] = JSON.stringify(that.storage);
console.log(localStorage[that.month]); 
}
} 
that.createEvent(that.ind,that.storage[that.ind]);
},
removeModal: function(el){
try{
while((el.lastChild != null)&&(el.lastChild.className == 'arrow-box')) el.removeChild(el.lastChild);
el.parentNode.removeChild(el.lastChild);
} catch (e){
return false;
}
return true;
},
renderCell: function(){
var list = document.createElement('ul');
document.getElementById('1').appendChild(list);
list.setAttribute('id','month'); 
var start = new Date(this.year,this.month,1),
td = start.getDay(),
countDay = 1;
console.log(td); // если td == 0
if(td==0){td = 7};
var a = function(t,elem){elem.innerHTML = t;} 
var daysOfweek = ['вс','пн','вт','ср','чт','пт','сб'];
var mnthNames = ['Январь','Февраль','Март','Апрель','Май','Июнь','Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'];
var daysAmmount = [31,28,31,30,31,30,31,31,30,31,30,31];

for(var i=0;i<35;i++){
var li = document.createElement('li'),
day = document.createElement('span');
list.appendChild(li);
li.classList.add('days'); 
day.classList.add('dayOfweek'); 
li.setAttribute('index',i);
if((i>=0)&&(i<7)){
li.appendChild(day);
if(i==6){a(daysOfweek[0],day)} else {a(daysOfweek[i+1],day);}
}
if(i==td-1){
if(countDay <= daysAmmount[this.month]){
var date = document.createElement('span');
li.appendChild(date);
date.classList.add('date'); 
a(countDay,date);
countDay++;
td++;}
}
var n = start.getDay();}
var prevMonthDays = daysAmmount[this.month-1];
var t = start.getDay();
if(t==0){t = 7};
for(var n=t-2;n >=0;n--)
{
var dat = document.createElement('span');
console.log(n);
console.log(list.children[n]);
list.children[n].appendChild(dat);
dat.classList.add('date'); 
a(prevMonthDays,dat); 
prevMonthDays--;
}
return list;
},
renderBox: function(){
var box = document.createElement('div'),//плашка для записи дела
form = document.createElement('form'),//форма 
arrow = document.createElement('i');//стрелочка
event.target.appendChild(box); //добавление плашки к ячейке, по которой кликнули
box.classList.add('arrow-box');
box.appendChild(form);
form.setAttribute('id','make_event');

//создание необходимых ДОМ-узлов 
function initElems(){
var elem = {};
elem.div = document.createElement('div');
elem.label = document.createElement('label');
elem.input = document.createElement('input');
return elem;
}

function makeInputBlock(name,id){
var el = initElems();
form.appendChild(el.div);
el.div.appendChild(el.label);
el.label.innerHTML = name;
el.label.setAttribute('for',id);
form.appendChild(el.div); 
el.div.appendChild(el.input);
el.input.setAttribute('id',id);
}

makeInputBlock('Events','action');
makeInputBlock('Members','members');
makeInputBlock('Time','time');

box.appendChild(arrow);
arrow.classList.add('arrow');
return box;
},
createEvent: function(ind,obj){
var span = document.createElement('span'),
list = document.getElementById('month');
list.children[ind].appendChild(span);
span.innerHTML = 'Event: ' + obj['action'];
span.innerHTML += '<br/>Members: ' +obj['members'];
span.innerHTML += '<br/>Time: ' +obj['time']; 
}
}
//localStorage.clear();
//начальная - текущая дата 
var today = new Date(),
year = today.getFullYear(),
month = today.getMonth(),
//создается экземпляр текущего месяца - объект передается текущий год и месяц
mnth = new Mnth(year,month); 
getEvents();
document.getElementById('currentM').innerHTML = month +' '+year;
//console.log(JSON.parse(localStorage[month]));
function getEvents(){
if(localStorage[month] !=undefined){
var obj = JSON.parse(localStorage[month]);
var calend = document.getElementById('month');
for(var i=0;i<calend.children.length;i++){
var ind = calend.children[i].getAttribute('index');
for(var key in obj){
if((key == ind) &&(obj[key] !== undefined)){
mnth.createEvent(ind,obj[key]);
}
}
}

}
else{console.log(2)}
};

//по клику на стрелку определяется новое значение месяца
//значение передается в новый экземпляр месяца
//в currentM - новый месяц
var changeMnth = document.getElementById('change_mnth');
changeMnth.onclick = function(){
var div = document.getElementById('1');
var m = document.getElementById('month');
div.removeChild(m);
delete mnth; 
if(event.target.getAttribute('value') == 'Previous'){
month -= 1;
if(month == -1){month = 11;year -=1;}
var mnth = new Mnth(year,month); 
getEvents();
document.getElementById('currentM').innerHTML = month +' '+year;
}else if(event.target.getAttribute('value') == 'Next'){
month += 1;
if(month == 12){month = 0;year +=1;}
var mnth = new Mnth(year,month); 
getEvents();
document.getElementById('currentM').innerHTML = month+' '+year;
}
}

}
</script>
</head>
<body>
<div id="change_mnth">
<input type="button" value="Previous"><span id="currentM"></span><input type="button" value="Next">
</div>
<div id = "1"></div>

</div>
</div>
</body>
</html>
